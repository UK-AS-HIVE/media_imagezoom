<!--
  Functions add simple custom controls to OpenLayers maps in Drupal,
  allowing to select one base layer and one overlay in dropdowns,
  and scrub transparency between them
-->  
<?php drupal_add_library('system', 'ui.slider'); ?>
<script language="javascript">
jQuery(document).ready(function()
{
  var map = Drupal.settings.openlayers.maps[jQuery('.openlayers-map').attr('id')];
  jQuery('.openlayers-map .olControlPanZoomBar').prepend('<div id="lichfieldLayerFader" style="position: relative; left: 50px;" class="clearfix"></div>');
  var baseSelect = '<select class="baseLayerSelect">';
  var opacitySlider = '<div id="opacitySlider" style="display: inline-block; width: 160px; font-size: 10px; margin: 5px;"></div>';
  var overlaySelect = '<select class="overlayLayerSelect">';
  for (var i=0; i<map[0].layers.length; ++i)
  {
    if (map[0].layers[i].isBaseLayer)
      baseSelect += '<option value="' + i + '">' + map[0].layers[i].title + '</option>';
    else
      overlaySelect += '<option value="' + i + '">' + map[0].layers[i].title + '</option>';
  }
  baseSelect += '</select>';
  overlaySelect += '</select>';
  jQuery('#lichfieldLayerFader').prepend(overlaySelect);
  jQuery('#lichfieldLayerFader').prepend(opacitySlider);
  jQuery('#lichfieldLayerFader').prepend(baseSelect);

  jQuery('#opacitySlider').slider({slide: function(event,ui) {setLayerOpacity(ui.value/100.0);} });

  jQuery('select.baseLayerSelect').change(function() {
    var map = Drupal.settings.openlayers.maps[jQuery('.openlayers-map').attr('id')];
    map[0].setBaseLayer(map[0].layers[jQuery(this).val()]);
  });
  jQuery('select.overlayLayerSelect').change(function() {
    var map = Drupal.settings.openlayers.maps[jQuery('.openlayers-map').attr('id')];
    var selectedLayerIndex = jQuery(this).val();
    for (var i=0; i<map[0].layers.length; ++i)
    {
      if (!map[0].layers[i].isBaseLayer)
        map[0].layers[i].setVisibility(i == selectedLayerIndex);
    }
  });
});

function setLayerOpacity(opacity)
{
  var map = Drupal.settings.openlayers.maps[jQuery('.openlayers-map').attr('id')];
  for (var i = 0; i<map[0].layers.length; ++i)
  {
    if (!map[0].layers[i].isBaseLayer)
      map[0].layers[i].setOpacity(opacity);
  }
}
</script>

